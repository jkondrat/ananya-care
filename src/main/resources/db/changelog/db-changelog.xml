<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="CARE #43" author="Łukasz Gąsior">
        <sql>
            insert into dashboard_app.dashboard (name, tab_position) values ('Mortality', 4);
            insert into dashboard_app.indicator_category (name, short_code, dashboard_id) values ('Mortality', 'MRT', (select dashboard_id from dashboard_app.dashboard where name = 'Mortality'));
            update dashboard_app.dashboard set indicator_category_id = 3 where dashboard_id = (select dashboard_id from dashboard_app.dashboard where name = 'Mortality');
        </sql>
    </changeSet>

    <changeSet id="CARE #10" author="Adrian Boguszewski">
        <dropColumn schemaName="dashboard_app" tableName="dashboard" columnName="indicator_category_id"/>
    </changeSet>

    <changeSet id="CARE #13" author="Łukasz Gąsior">
        <sql>
            update dashboard_app.area set name = 'Bihar', level_id = 1, parent_area_id = null where area_id = 1;
            update dashboard_app.area set name = 'Begusarai', level_id = 2, parent_area_id = 1 where area_id = 2;
            update dashboard_app.area set name = 'Champaran East', level_id = 2, parent_area_id = 1 where area_id = 3;
            update dashboard_app.area set name = 'Patna', level_id = 2, parent_area_id = 1 where area_id = 4;
            update dashboard_app.area set name = 'Saharsa', level_id = 2, parent_area_id = 1 where area_id = 5;
            delete from dashboard_app.area where name not in ('Begusarai', 'Champaran East', 'Patna', 'Saharsa', 'Bihar');
            update dashboard_app.care_user set area_id = 1;
        </sql>
    </changeSet>

    <changeSet id="CARE #46" author="Lech Różański">
        <sql>
            insert into dashboard_app.dashboard (name, tab_position) values ('Essential Newborn Care', 4);
            insert into dashboard_app.indicator_category (name, short_code, dashboard_id) values ('Essential Newborn Care', 'ENC', 5);
            insert into dashboard_app.trend (positive_diff, negative_diff, creation_date, modification_date)
                values (1, -1, now(), now());
            insert into dashboard_app.complex_condition(name, creation_date, modification_date)
                values ('delivery_child_form.breastfed_hour = Yes', now(), now());
            insert into dashboard_app.condition(complex_condition_id, computed_field_id, comparison_symbol_id, comparison_value, creation_date, modification_date)
                values (2, 847, 1, true, now(), now());
            insert into dashboard_app.indicator (type_id, area_id, trend_id, complex_condition_id, computed_field_id, frequency, name, creation_date, modification_date)
                values (3, 1, 2, 2, 847, 30, '% of new born breastfed within one hour of delivery', now(), now());
            insert into dashboard_app.indicator_indicator_category(indicator_id, indicator_category_id) values (2, 3);
            insert into dashboard_app.report (indicator_id, report_type_id, creation_date, modification_date)
                values (2, 3, now(), now());
            insert into dashboard_app.indicator_user(indicator_id, user_id) values (2, 1);
        </sql>
    </changeSet>

    <changeSet id="CARE #5" author="Adrian Boguszewski">
        <addUniqueConstraint columnNames="short_code"
                             constraintName="short_code_uk"
                             schemaName="dashboard_app"
                             tableName="indicator_category"/>
    </changeSet>

    <changeSet id="CARE #26" author="Lech Różański">
        <dropColumn schemaName="dashboard_app"
                    tableName="condition"
                    columnName="comparison_value" />
        <renameColumn schemaName="dashboard_app"
                      tableName="condition"
                      oldColumnName="computed_field_id"
                      newColumnName="field_1_id" />
        <sql>
            create table dashboard_app.field_comparison (
                field_comparison_id serial not null,
                condition_id integer not null,
                field_2_id integer not null,
                constraint field_comparison_pk primary key (field_comparison_id),
                constraint field_comparison_condition_id foreign key (condition_id)
                references dashboard_app.condition (condition_id) match full
                on delete cascade on update cascade not deferrable,
                constraint field_comparison_field_2_id foreign key (field_2_id)
                references dashboard_app.computed_field (computed_field_id) match full
                on delete cascade on update cascade not deferrable
            );

            create table dashboard_app.value_comparison (
                value_comparison_id serial not null,
                condition_id integer not null,
                value character varying(50) not null,
                constraint value_comparison_pk primary key (value_comparison_id),
                constraint field_comparison_condition_id foreign key (condition_id)
                references dashboard_app.condition (condition_id) match full
                on delete cascade on update cascade not deferrable
            );

            create table dashboard_app.date_diff_comparison (
                date_diff_comparison_id serial not null,
                condition_id integer not null,
                field_2_id integer not null,
                value integer not null,
                constraint date_diff_comparison_pk primary key (date_diff_comparison_id),
                constraint field_comparison_condition_id foreign key (condition_id)
                references dashboard_app.condition (condition_id) match full
                on delete cascade on update cascade not deferrable,
                constraint date_diff_comparison_field_2_id foreign key (field_2_id)
                references dashboard_app.computed_field (computed_field_id) match full
                on delete cascade on update cascade not deferrable
            );
        </sql>
    </changeSet>

</databaseChangeLog>
